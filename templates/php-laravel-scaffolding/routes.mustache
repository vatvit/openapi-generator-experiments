{{>php_file_header}}
/**
 * GENERATED API ROUTES
 *
 * This file is generated from OpenAPI specification.
 * Include this file from your Laravel routes/api.php within a Route::group.
 *
 * Controller name is defined in OpenAPI spec: info.title
 *
 * Routes will use middleware groups with 'api.middlewareGroup.' prefix if they are defined.
 * For example: 'api.middlewareGroup.findPets', 'api.middlewareGroup.addPet', etc.
 * Define these groups in bootstrap/app.php only when you need custom middleware for an operation.
 *
 * Usage in routes/api.php:
 * ```php
 * // Bind controller name to concrete implementation in Service Container
 * app()->bind('{{appName}}', \App\Http\Controllers\Api\YourController::class);
 *
 * // Wrap generated routes in a group
 * Route::group(['prefix' => 'v2', 'middleware' => ['api']], function ($router) {
 *     require base_path('generated/scaffolding/routes.php');
 * });
 * ```
 *
 * MIDDLEWARE USAGE:
 *
 * Routes will automatically use middleware groups named 'api.middlewareGroup.{operationId}'
 * if they are defined in your application. Define middleware groups in bootstrap/app.php:
 *
 * ```php
 * ->withMiddleware(function (Middleware $middleware): void {
 *     // Define middleware groups for specific operations
 *     $middleware->group('api.middlewareGroup.findPets', [
 *         \App\Http\Middleware\CacheResponse::class,
 *     ]);
 *
 *     $middleware->group('api.middlewareGroup.addPet', [
 *         \App\Http\Middleware\ValidateOwnership::class,
 *         \App\Http\Middleware\LogCreation::class,
 *     ]);
 *
 *     $middleware->group('api.middlewareGroup.deletePet', [
 *         \App\Http\Middleware\RequireAdmin::class,
 *     ]);
 * })
 * ```
 *
 * Routes will only have middleware attached if their corresponding group is defined.
 * Operations without defined middleware groups will have no middleware applied.
 */

// Use $router variable passed from Route::group closure
// This file expects $router to be available from the including context

{{#apiInfo}}
{{#apis}}
{{#operations}}
{{#operation}}
/**
 * {{httpMethod}} {{{path}}}
 * {{#summary}}{{summary}}{{/summary}}
 * {{#notes}}{{notes}}{{/notes}}
{{#hasAuthMethods}}
 *
 * Security Requirements:
{{#authMethods}}
 * - {{name}} ({{type}}){{#description}}: {{description}}{{/description}}
{{#isApiKey}}
 *   Location: {{keyParamName}} in {{#isKeyInHeader}}header{{/isKeyInHeader}}{{#isKeyInQuery}}query{{/isKeyInQuery}}
{{/isApiKey}}
{{#isBasicBearer}}
 *   Format: Bearer token (JWT)
{{/isBasicBearer}}
{{#isOAuth}}
 *   Required scopes: {{#scopes}}{{scope}}{{^-last}}, {{/-last}}{{/scopes}}
{{/isOAuth}}
{{/authMethods}}
 *
 * Suggested middleware group (in bootstrap/app.php):
 * $middleware->group('api.middlewareGroup.{{operationId}}', [
{{#authMethods}}
{{#isApiKey}}
 *     \App\Http\Middleware\ValidateApiKey::class,  // Validate {{keyParamName}} header/query
{{/isApiKey}}
{{#isBasicBasic}}
 *     \App\Http\Middleware\ValidateBasicAuth::class,
{{/isBasicBasic}}
{{#isBasicBearer}}
 *     \App\Http\Middleware\ValidateBearerToken::class,  // Validate JWT token
{{/isBasicBearer}}
{{#isOAuth}}
 *     \App\Http\Middleware\ValidateOAuthScopes::class,  // Validate scopes: {{#scopes}}{{scope}}{{^-last}}, {{/-last}}{{/scopes}}
{{/isOAuth}}
{{/authMethods}}
 * ]);
{{/hasAuthMethods}}
 */
$route = $router->{{httpMethod}}('{{{basePathWithoutHost}}}{{{path}}}', '{{appName}}@{{operationId}}')
    ->name('api.{{operationId}}');

{{#hasAuthMethods}}
// SECURITY VALIDATION: This operation requires authentication
// Middleware MUST implement one of the required security interfaces
if (!$router->hasMiddlewareGroup('api.middlewareGroup.{{operationId}}')) {
    throw new \RuntimeException(
        "Security violation: Operation '{{operationId}}' requires authentication but " .
        "middleware group 'api.middlewareGroup.{{operationId}}' is not defined. " .
        "Required security: {{#authMethods}}{{name}}{{^-last}} OR {{/-last}}{{/authMethods}}"
    );
}

$middlewares = app('router')->getMiddlewareGroups()['api.middlewareGroup.{{operationId}}'] ?? [];
$requiredInterfaces = [
{{#authMethods}}
    {{invokerPackage}}\Security\{{name}}Interface::class,
{{/authMethods}}
];

// Validate that at least ONE middleware implements a required security interface (OR logic)
$hasValidSecurity = false;
foreach ($middlewares as $middleware) {
    $middlewareClass = is_string($middleware) ? $middleware : get_class($middleware);
    foreach ($requiredInterfaces as $interface) {
        if (is_subclass_of($middlewareClass, $interface)) {
            $hasValidSecurity = true;
            break 2;
        }
    }
}

if (!$hasValidSecurity) {
    $interfaceNames = array_map(fn($i) => class_basename($i), $requiredInterfaces);
    throw new \RuntimeException(
        "Security violation: Operation '{{operationId}}' requires middleware implementing one of: " .
        implode(' OR ', $interfaceNames) . ". " .
        "Middleware group 'api.middlewareGroup.{{operationId}}' contains: " .
        implode(', ', array_map(fn($m) => is_string($m) ? class_basename($m) : get_class($m), $middlewares))
    );
}

$route->middleware('api.middlewareGroup.{{operationId}}');
{{/hasAuthMethods}}
{{^hasAuthMethods}}
// No security required - public endpoint
// Middleware can still be attached if group is defined
if ($router->hasMiddlewareGroup('api.middlewareGroup.{{operationId}}')) {
    $route->middleware('api.middlewareGroup.{{operationId}}');
}
{{/hasAuthMethods}}

{{/operation}}
{{/operations}}
{{/apis}}
{{/apiInfo}}
